################################################################################
# Functional Annotation Pipeline - Configuration File
# 
# Author: Aaron Kiggen
# Repository: aaronkiggen/Functional_Annotation_Pipeline
#
# Description: Central configuration file for all pipeline steps
# Usage: Source this file in SLURM scripts with: source config.env
################################################################################

################################################################################
# Base Directories
################################################################################

# Project root directory (adjust to your setup)
PROJECT_ROOT="${HOME}/Functional_Annotation_Pipeline"

# Input data directory
INPUT_DIR="${PROJECT_ROOT}/input_proteomes"

# Processed data (longest isoforms)
PRIMARY_TRANSCRIPTS_DIR="${PROJECT_ROOT}/primary_transcripts"

# Results base directory
RESULTS_DIR="${PROJECT_ROOT}/results"

# Logs directory
LOG_DIR="${PROJECT_ROOT}/logs"

# Temporary/scratch directory (for large intermediate files)
TMP_DIR="${VSC_SCRATCH}/tmp"

################################################################################
# Database Root Directory
################################################################################

# Central location for all databases
DB_ROOT="${HOME}/databases"

################################################################################
# Step 01: Preprocessing - Longest Isoform Extraction
################################################################################

# Input file pattern
INPUT_PATTERN="*.faa"

# Output directory for processed files
STEP01_OUTPUT="${PRIMARY_TRANSCRIPTS_DIR}"

# Minimum sequence length (amino acids)
MIN_SEQ_LENGTH="50"

################################################################################
# Step 02: KofamScan - KEGG Orthology Annotation
################################################################################

# Conda environment
KOFAM_ENV="kofam"

# Database directory
KOFAM_DB="${DB_ROOT}/kofamscan"

# KofamScan configuration file
KOFAM_CONFIG="${KOFAM_DB}/config.yml"

# KofamScan profiles and ko_list
KOFAM_PROFILES="${KOFAM_DB}/profiles"
KOFAM_KO_LIST="${KOFAM_DB}/ko_list"

# Output directory
KOFAM_OUTPUT="${RESULTS_DIR}/kofamscan"

# KofamScan parameters
KOFAM_EVALUE="1e-5"
KOFAM_TMP_DIR="${TMP_DIR}/kofamscan"

################################################################################
# Step 03: InterProScan - Domain and Motif Analysis
################################################################################

# InterProScan installation directory
INTERPROSCAN_HOME="${HOME}/tools/interproscan-5.76-107.0"

# Output directory
INTERPROSCAN_OUTPUT="${RESULTS_DIR}/interproscan"

# InterProScan temporary directory
INTERPROSCAN_TMP_DIR="${TMP_DIR}/interproscan"

# Output formats (comma-separated: TSV,GFF3,XML,JSON)
INTERPROSCAN_FORMATS="TSV,GFF3"

# Applications to run (leave empty for all, or specify: Pfam,TIGRFAM,SUPERFAMILY,etc.)
INTERPROSCAN_APPL="Pfam,TIGRFAM,SUPERFAMILY,Gene3D,SMART"

# Additional options
INTERPROSCAN_GOTERMS="true"      # Include GO term annotations
INTERPROSCAN_IPRLOOKUP="true"    # Map to InterPro entries
INTERPROSCAN_PATHWAYS="true"     # Include pathway annotations
INTERPROSCAN_PRECALC="true"      # Use precalculated match lookup service

################################################################################
# Step 04: EggNOG 7 - Functional Annotation via Diamond
################################################################################

# Conda environment (for EggNOG v5)
EGGNOG_ENV="eggnog_2025"

# EggNOG 7 database files
EGGNOG_DIAMOND_DB="${DB_ROOT}/eggnog7/eggnog7_20251223_proteins.dmnd"
EGGNOG_MASTER_TABLE="${DB_ROOT}/eggnog7/eggnog7_20251223_master_search_table.tsv.gz"

# EggNOG 7 annotator script location (now included in the repository)
# _AK suffix denotes Aaron Kiggen's adapted version from the original fischuu/eggnog7_annotator
EGGNOG7_SCRIPT="${PROJECT_ROOT}/scripts/eggnog7_annotator/eggnog7_annotator_AK.sh"

# Output directory
EGGNOG_OUTPUT="${RESULTS_DIR}/eggnog7"

# Diamond parameters
EGGNOG_EVALUE="1e-5"
KEEP_DIAMOND="false"  # Set to "true" to keep intermediate Diamond TSV files

################################################################################
# Step 05: OrthoFinder - Comparative Genomics
################################################################################

# Conda environment
ORTHOFINDER_ENV="of3"

# Output directory
ORTHOFINDER_OUTPUT="${RESULTS_DIR}/orthofinder"

# Search program: "diamond" (fast) or "blast" (sensitive)
ORTHOFINDER_SEARCH="diamond"

# MSA method: "msa" or "denovo"
ORTHOFINDER_MSA="msa"

# Tree inference: "fasttree", "raxml", "iqtree"
ORTHOFINDER_TREE="fasttree"

# MCL inflation parameter (1.5-3.0, higher = more granular clusters)
ORTHOFINDER_MCL_INFLATION="1.5"

# Run name (useful for multiple analyses)
ORTHOFINDER_RUN_NAME="run_$(date +%Y%m%d)"

################################################################################
# Step 06: FANTASIA - AI-Driven Annotation (GPU)
################################################################################

# FANTASIA container image
FANTASIA_CONTAINER="${PROJECT_ROOT}/containers/fantasia.sif"

# FANTASIA configuration file
FANTASIA_CONFIG="${PROJECT_ROOT}/fantasia/config.yaml"

# Output directory
FANTASIA_OUTPUT="${RESULTS_DIR}/fantasia"

# Model paths
FANTASIA_EMBEDDING_MODEL="${DB_ROOT}/models/prot_bert.bin"
FANTASIA_LLM_MODEL="${DB_ROOT}/models/biogpt.bin"
FANTASIA_TOKENIZER="${DB_ROOT}/models/tokenizer"

# Database settings
FANTASIA_PGDATA="${VSC_SCRATCH}/fantasia_db"
FANTASIA_DB_NAME="fantasia_vectors"
FANTASIA_DB_USER="fantasia_user"
FANTASIA_DB_PASSWORD="secure_password_change_me"

# RabbitMQ settings
FANTASIA_RABBITMQ_HOST="localhost"
FANTASIA_RABBITMQ_PORT="5672"
FANTASIA_RABBITMQ_QUEUE="annotation_jobs"

# Annotation parameters
FANTASIA_BATCH_SIZE="32"
FANTASIA_MIN_CONFIDENCE="0.7"
FANTASIA_WORKERS="4"
FANTASIA_FP16="true"  # Use mixed precision for faster inference

# Reference databases for semantic search
FANTASIA_REF_DB="${DB_ROOT}/uniprot/uniprot_sprot.faa"

################################################################################
# General Settings
################################################################################

# Keep intermediate files
KEEP_INTERMEDIATE="false"

# Compress output files
COMPRESS_OUTPUT="true"

# Cleanup temporary files after successful completion
CLEANUP_TMP="true"

################################################################################
# Export all variables
################################################################################

export PROJECT_ROOT INPUT_DIR PRIMARY_TRANSCRIPTS_DIR RESULTS_DIR LOG_DIR TMP_DIR DB_ROOT
export INPUT_PATTERN STEP01_OUTPUT MIN_SEQ_LENGTH
export KOFAM_ENV KOFAM_DB KOFAM_CONFIG KOFAM_PROFILES KOFAM_KO_LIST KOFAM_OUTPUT
export KOFAM_EVALUE KOFAM_TMP_DIR
export INTERPROSCAN_HOME INTERPROSCAN_OUTPUT INTERPROSCAN_TMP_DIR
export INTERPROSCAN_FORMATS INTERPROSCAN_APPL
export INTERPROSCAN_GOTERMS INTERPROSCAN_IPRLOOKUP INTERPROSCAN_PATHWAYS INTERPROSCAN_PRECALC
export EGGNOG_ENV EGGNOG_DIAMOND_DB EGGNOG_MASTER_TABLE EGGNOG7_SCRIPT EGGNOG_OUTPUT
export EGGNOG_EVALUE KEEP_DIAMOND
export ORTHOFINDER_ENV ORTHOFINDER_OUTPUT ORTHOFINDER_SEARCH ORTHOFINDER_MSA ORTHOFINDER_TREE
export ORTHOFINDER_MCL_INFLATION ORTHOFINDER_RUN_NAME
export FANTASIA_CONTAINER FANTASIA_CONFIG FANTASIA_OUTPUT
export FANTASIA_EMBEDDING_MODEL FANTASIA_LLM_MODEL FANTASIA_TOKENIZER
export FANTASIA_PGDATA FANTASIA_DB_NAME FANTASIA_DB_USER FANTASIA_DB_PASSWORD
export FANTASIA_RABBITMQ_HOST FANTASIA_RABBITMQ_PORT FANTASIA_RABBITMQ_QUEUE
export FANTASIA_BATCH_SIZE FANTASIA_MIN_CONFIDENCE FANTASIA_WORKERS FANTASIA_FP16
export FANTASIA_REF_DB
export KEEP_INTERMEDIATE COMPRESS_OUTPUT CLEANUP_TMP

################################################################################
# End of Configuration
################################################################################
