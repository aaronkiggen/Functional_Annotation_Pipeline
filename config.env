################################################################################
# Functional Annotation Pipeline - Configuration File
# 
# Author: Aaron Kiggen
# Repository: aaronkiggen/Functional_Annotation_Pipeline
#
# Description: Central configuration file for all pipeline steps
# Usage: Source this file in SLURM scripts with: source config.env
#
# Last Updated: 2026-01-24
################################################################################

################################################################################
# Base Directories
################################################################################

# Project root directory (adjust to your setup)
PROJECT_ROOT="${HOME}/Functional_Annotation_Pipeline"

# Input data directory
INPUT_DIR="${PROJECT_ROOT}/input_proteomes"

# Processed data (longest isoforms)
PRIMARY_TRANSCRIPTS_DIR="${PROJECT_ROOT}/primary_transcripts"

# Results base directory
RESULTS_DIR="${PROJECT_ROOT}/results"

# Logs directory
LOG_DIR="${PROJECT_ROOT}/logs"

# Temporary/scratch directory (for large intermediate files)
TMP_DIR="${VSC_SCRATCH}/tmp"  # Use ${TMPDIR} or /tmp if not on VSC

################################################################################
# Database Root Directory
################################################################################

# Central location for all databases
DB_ROOT="${HOME}/databases"

################################################################################
# Step 01: Preprocessing - Longest Isoform Extraction
################################################################################


# Input file pattern
INPUT_PATTERN="*.faa"

# Output directory for processed files
STEP01_OUTPUT="${PRIMARY_TRANSCRIPTS_DIR}"

# Minimum sequence length (amino acids)
MIN_SEQ_LENGTH="50"

################################################################################
# Step 02: KofamScan - KEGG Orthology Annotation
################################################################################

# Conda environment
KOFAM_ENV="kofam"

# Database directory
KOFAM_DB="${DB_ROOT}/kofamscan"

# KofamScan configuration file
KOFAM_CONFIG="${KOFAM_DB}/config.yml"

# KofamScan profiles and ko_list
KOFAM_PROFILES="${KOFAM_DB}/profiles"
KOFAM_KO_LIST="${KOFAM_DB}/ko_list"

# Output directory
KOFAM_OUTPUT="${RESULTS_DIR}/kofamscan"

# KofamScan parameters
KOFAM_EVALUE="1e-5"
KOFAM_CPU="16"
KOFAM_TMP_DIR="${TMP_DIR}/kofamscan"

################################################################################
# Step 03: InterProScan - Domain and Motif Analysis
################################################################################

# InterProScan installation directory
INTERPROSCAN_HOME="${HOME}/tools/interproscan-5.67-99.0"

# Output directory
INTERPROSCAN_OUTPUT="${RESULTS_DIR}/interproscan"

# InterProScan parameters
INTERPROSCAN_CPU="32"
INTERPROSCAN_MEMORY="64"  # GB
INTERPROSCAN_TMP_DIR="${TMP_DIR}/interproscan"

# Output formats (comma-separated: TSV,GFF3,XML,JSON)
INTERPROSCAN_FORMATS="TSV,GFF3"

# Applications to run (leave empty for all, or specify: Pfam,TIGRFAM,SUPERFAMILY,etc.)
INTERPROSCAN_APPL="Pfam,TIGRFAM,SUPERFAMILY,Gene3D,SMART"

# Additional options
INTERPROSCAN_GOTERMS="true"      # Include GO term annotations
INTERPROSCAN_IPRLOOKUP="true"    # Map to InterPro entries
INTERPROSCAN_PATHWAYS="true"     # Include pathway annotations
INTERPROSCAN_PRECALC="true"      # Use precalculated match lookup service

# Java options for InterProScan
INTERPROSCAN_JAVA_OPTS="-Xms2G -Xmx${INTERPROSCAN_MEMORY}G"

################################################################################
# Step 04: EggNOG 7 - Functional Annotation via Diamond
################################################################################

# EggNOG 7 database files
EGGNOG_DIAMOND_DB="${DB_ROOT}/eggnog7/eggnog7_20251223_proteins.dmnd"
EGGNOG_MASTER_TABLE="${DB_ROOT}/eggnog7/eggnog7_20251223_master_search_table.tsv.gz"

# EggNOG 7 annotator script location
EGGNOG7_SCRIPT="${PROJECT_ROOT}/tools/eggnog7_annotator.sh"

# Output directory
EGGNOG_OUTPUT="${RESULTS_DIR}/eggnog7"

# Diamond parameters
EGGNOG_EVALUE="1e-5"
EGGNOG_CPU="32"
KEEP_DIAMOND="false"  # Set to "true" to keep intermediate Diamond TSV files

# Module or conda environment
EGGNOG_MODULE="Diamond/2.1.8-GCC-12.2.0"
# EGGNOG_ENV="eggnog_2025"  # Alternative: use conda environment

################################################################################
# Step 05: OrthoFinder - Comparative Genomics
################################################################################

# Conda environment
ORTHOFINDER_ENV="of3"

# Output directory
ORTHOFINDER_OUTPUT="${RESULTS_DIR}/orthofinder"

# OrthoFinder parameters
ORTHOFINDER_CPU="64"
ORTHOFINDER_TREE_CPU="32"

# Search program: "diamond" (fast) or "blast" (sensitive)
ORTHOFINDER_SEARCH="diamond"

# MSA method: "msa" or "denovo"
ORTHOFINDER_MSA="msa"

# Tree inference: "fasttree", "raxml", "iqtree"
ORTHOFINDER_TREE="fasttree"

# MCL inflation parameter (1.5-3.0, higher = more granular clusters)
ORTHOFINDER_MCL_INFLATION="1.5"

# Run name (useful for multiple analyses)
ORTHOFINDER_RUN_NAME="run_$(date +%Y%m%d)"

################################################################################
# Step 06: FANTASIA - AI-Driven Annotation (GPU)
################################################################################

# FANTASIA container image
FANTASIA_CONTAINER="${PROJECT_ROOT}/containers/fantasia.sif"

# FANTASIA configuration file
FANTASIA_CONFIG="${PROJECT_ROOT}/fantasia/config.yaml"

# Output directory
FANTASIA_OUTPUT="${RESULTS_DIR}/fantasia"

# GPU settings
FANTASIA_GPU_TYPE="a100"  # a100, v100, h100, etc.
FANTASIA_GPU_COUNT="1"

# Model paths
FANTASIA_EMBEDDING_MODEL="${DB_ROOT}/models/prot_bert.bin"
FANTASIA_LLM_MODEL="${DB_ROOT}/models/biogpt.bin"
FANTASIA_TOKENIZER="${DB_ROOT}/models/tokenizer"

# Database settings
FANTASIA_PGDATA="${VSC_SCRATCH}/fantasia_db"
FANTASIA_DB_NAME="fantasia_vectors"
FANTASIA_DB_USER="fantasia_user"
FANTASIA_DB_PASSWORD="secure_password_change_me"

# RabbitMQ settings
FANTASIA_RABBITMQ_HOST="localhost"
FANTASIA_RABBITMQ_PORT="5672"
FANTASIA_RABBITMQ_QUEUE="annotation_jobs"

# Annotation parameters
FANTASIA_CPU="16"
FANTASIA_BATCH_SIZE="32"
FANTASIA_MIN_CONFIDENCE="0.7"
FANTASIA_WORKERS="4"
FANTASIA_FP16="true"  # Use mixed precision for faster inference

# Reference databases for semantic search
FANTASIA_REF_DB="${DB_ROOT}/uniprot/uniprot_sprot.faa"

################################################################################
# HPC/SLURM Settings
################################################################################

# Default partitions
CPU_PARTITION="cpu"
GPU_PARTITION="gpu"

# Default time limits (format: HH:MM:SS or D-HH:MM:SS)
PREPROCESSING_TIME="01:00:00"
KOFAM_TIME="12:00:00"
INTERPROSCAN_TIME="48:00:00"
EGGNOG_TIME="12:00:00"
ORTHOFINDER_TIME="48:00:00"
FANTASIA_TIME="48:00:00"

# Email notifications (optional)
SLURM_EMAIL=""  # Set to your email to receive job notifications
SLURM_MAIL_TYPE="END,FAIL"  # Options: BEGIN,END,FAIL,ALL

################################################################################
# Module Loading (VSC-specific)
################################################################################

# Modules to load (adjust for your HPC system)
MODULE_CUDA="CUDA/11.8.0-GCC-12.2.0"
MODULE_APPTAINER="Apptainer/1.1.6"
MODULE_POSTGRESQL="PostgreSQL/14.5-GCCcore-12.2.0"
MODULE_JAVA="Java/11.0.16"
MODULE_DIAMOND="Diamond/2.1.8-GCC-12.2.0"
MODULE_PYTHON="Python/3.10.4-GCCcore-11.3.0"

################################################################################
# Conda Settings
################################################################################

# Conda installation path (if not using system conda)
CONDA_HOME="${HOME}/miniconda3"

# Initialize conda in scripts
CONDA_INIT="${CONDA_HOME}/etc/profile.d/conda.sh"

################################################################################
# Resource Limits
################################################################################

# Memory limits per step (in GB)
PREPROCESSING_MEM="8"
KOFAM_MEM="32"
INTERPROSCAN_MEM="64"
EGGNOG_MEM="64"
ORTHOFINDER_MEM="128"
FANTASIA_MEM="128"

# CPU/thread limits per step
PREPROCESSING_CPU="4"
KOFAM_CPU="16"
INTERPROSCAN_CPU="32"
EGGNOG_CPU="32"
ORTHOFINDER_CPU="64"
FANTASIA_CPU="16"

################################################################################
# Output and Logging
################################################################################

# Verbosity level (0=quiet, 1=normal, 2=verbose)
VERBOSE="1"

# Keep intermediate files
KEEP_INTERMEDIATE="false"

# Compress output files
COMPRESS_OUTPUT="true"

# Log file format
LOG_DATE_FORMAT="+%Y-%m-%d %H:%M:%S"

################################################################################
# Data Validation
################################################################################

# Minimum sequences per file to process
MIN_SEQUENCES="10"

# Maximum sequence length (amino acids, 0 = no limit)
MAX_SEQ_LENGTH="50000"

# Skip files with validation errors
SKIP_INVALID_FILES="true"

################################################################################
# Advanced Options
################################################################################

# Retry failed jobs
RETRY_FAILED="false"
MAX_RETRIES="3"

# Job dependencies (set to "true" to auto-chain steps)
AUTO_DEPENDENCY="false"

# Cleanup temporary files after successful completion
CLEANUP_TMP="true"

################################################################################
# Version Information
################################################################################

PIPELINE_VERSION="1.0.0"
CONFIG_VERSION="1.0"
LAST_UPDATED="2026-01-24"

################################################################################
# User-specific Overrides
################################################################################

# Source user-specific configuration if it exists
USER_CONFIG="${PROJECT_ROOT}/config.user.env"
if [ -f "${USER_CONFIG}" ]; then
    source "${USER_CONFIG}"
fi

################################################################################
# Validation Functions
################################################################################

# Function to validate configuration
validate_config() {
    echo "Validating configuration..."
    
    # Check critical directories
    [ ! -d "${INPUT_DIR}" ] && echo "WARNING: Input directory not found: ${INPUT_DIR}"
    
    # Check database files
    [ ! -d "${KOFAM_DB}" ] && echo "WARNING: KofamScan database not found: ${KOFAM_DB}"
    [ ! -f "${EGGNOG_DIAMOND_DB}" ] && echo "WARNING: EggNOG Diamond DB not found: ${EGGNOG_DIAMOND_DB}"
    
    # Check InterProScan installation
    [ ! -d "${INTERPROSCAN_HOME}" ] && echo "WARNING: InterProScan not found: ${INTERPROSCAN_HOME}"
    
    echo "Configuration validation complete."
}

# Function to create required directories
setup_directories() {
    echo "Creating required directories..."
    mkdir -p "${INPUT_DIR}"
    mkdir -p "${PRIMARY_TRANSCRIPTS_DIR}"
    mkdir -p "${RESULTS_DIR}"
    mkdir -p "${LOG_DIR}"
    mkdir -p "${TMP_DIR}"
    mkdir -p "${KOFAM_OUTPUT}"
    mkdir -p "${INTERPROSCAN_OUTPUT}"
    mkdir -p "${EGGNOG_OUTPUT}"
    mkdir -p "${ORTHOFINDER_OUTPUT}"
    mkdir -p "${FANTASIA_OUTPUT}"
    echo "Directories created."
}

# Function to print configuration summary
print_config_summary() {
    echo "========================================="
    echo "Pipeline Configuration Summary"
    echo "========================================="
    echo "Pipeline Version: ${PIPELINE_VERSION}"
    echo "Project Root: ${PROJECT_ROOT}"
    echo "Input Directory: ${INPUT_DIR}"
    echo "Results Directory: ${RESULTS_DIR}"
    echo "Database Root: ${DB_ROOT}"
    echo "Temporary Directory: ${TMP_DIR}"
    echo ""
    echo "Conda Environments:"
    echo "  - KofamScan: ${KOFAM_ENV}"
    echo "  - EggNOG: ${EGGNOG_ENV:-N/A (using modules)}"
    echo "  - OrthoFinder: ${ORTHOFINDER_ENV}"
    echo ""
    echo "CPU Resources:"
    echo "  - KofamScan: ${KOFAM_CPU} cores"
    echo "  - InterProScan: ${INTERPROSCAN_CPU} cores"
    echo "  - EggNOG: ${EGGNOG_CPU} cores"
    echo "  - OrthoFinder: ${ORTHOFINDER_CPU} cores"
    echo ""
    echo "GPU Resources:"
    echo "  - FANTASIA: ${FANTASIA_GPU_COUNT}x ${FANTASIA_GPU_TYPE}"
    echo "========================================="
}

################################################################################
# Export all variables
################################################################################

export PROJECT_ROOT INPUT_DIR PRIMARY_TRANSCRIPTS_DIR RESULTS_DIR LOG_DIR TMP_DIR DB_ROOT
export PYTHON_ENV INPUT_PATTERN STEP01_OUTPUT MIN_SEQ_LENGTH
export KOFAM_ENV KOFAM_DB KOFAM_CONFIG KOFAM_PROFILES KOFAM_KO_LIST KOFAM_OUTPUT
export KOFAM_EVALUE KOFAM_CPU KOFAM_TMP_DIR
export INTERPROSCAN_HOME INTERPROSCAN_OUTPUT INTERPROSCAN_CPU INTERPROSCAN_MEMORY
export INTERPROSCAN_TMP_DIR INTERPROSCAN_FORMATS INTERPROSCAN_APPL
export INTERPROSCAN_GOTERMS INTERPROSCAN_IPRLOOKUP INTERPROSCAN_PATHWAYS INTERPROSCAN_PRECALC
export INTERPROSCAN_JAVA_OPTS
export EGGNOG_DIAMOND_DB EGGNOG_MASTER_TABLE EGGNOG7_SCRIPT EGGNOG_OUTPUT
export EGGNOG_EVALUE EGGNOG_CPU KEEP_DIAMOND EGGNOG_MODULE
export ORTHOFINDER_ENV ORTHOFINDER_OUTPUT ORTHOFINDER_CPU ORTHOFINDER_TREE_CPU
export ORTHOFINDER_SEARCH ORTHOFINDER_MSA ORTHOFINDER_TREE ORTHOFINDER_MCL_INFLATION
export ORTHOFINDER_RUN_NAME
export FANTASIA_CONTAINER FANTASIA_CONFIG FANTASIA_OUTPUT FANTASIA_GPU_TYPE FANTASIA_GPU_COUNT
export FANTASIA_EMBEDDING_MODEL FANTASIA_LLM_MODEL FANTASIA_TOKENIZER
export FANTASIA_PGDATA FANTASIA_DB_NAME FANTASIA_DB_USER FANTASIA_DB_PASSWORD
export FANTASIA_RABBITMQ_HOST FANTASIA_RABBITMQ_PORT FANTASIA_RABBITMQ_QUEUE
export FANTASIA_CPU FANTASIA_BATCH_SIZE FANTASIA_MIN_CONFIDENCE FANTASIA_WORKERS
export FANTASIA_FP16 FANTASIA_REF_DB
export CPU_PARTITION GPU_PARTITION
export PREPROCESSING_TIME KOFAM_TIME INTERPROSCAN_TIME EGGNOG_TIME ORTHOFINDER_TIME FANTASIA_TIME
export SLURM_EMAIL SLURM_MAIL_TYPE
export MODULE_CUDA MODULE_APPTAINER MODULE_POSTGRESQL MODULE_JAVA MODULE_DIAMOND MODULE_PYTHON
export CONDA_HOME CONDA_INIT
export PREPROCESSING_MEM KOFAM_MEM INTERPROSCAN_MEM EGGNOG_MEM ORTHOFINDER_MEM FANTASIA_MEM
export PREPROCESSING_CPU INTERPROSCAN_CPU EGGNOG_CPU ORTHOFINDER_CPU FANTASIA_CPU
export VERBOSE KEEP_INTERMEDIATE COMPRESS_OUTPUT LOG_DATE_FORMAT
export MIN_SEQUENCES MAX_SEQ_LENGTH SKIP_INVALID_FILES
export RETRY_FAILED MAX_RETRIES AUTO_DEPENDENCY CLEANUP_TMP
export PIPELINE_VERSION CONFIG_VERSION LAST_UPDATED


